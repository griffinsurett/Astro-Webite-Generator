---
import CollectionItemLayout from "../../layouts/CollectionItemLayout.astro";

// Components Imports
import Section from "../../components/Section.astro";
import Image from "../../components/Image.astro";
import ContentTemplate from "../../components/ContentTemplate.astro";
import ItemsTemplate from "../../components/ItemsTemplate.astro";
import ServiceCard from "../../components/ServiceCard.astro";
import CollectionCard from "../../components/CollectionsCard.astro";

// Utils Imports
import { getCollectionItemPageData } from "../../utils/collections/";
import { generateItemPaths } from "../../utils/collections/collectionPaths.js"; // Import generateItemPaths
import { handleTwoSegmentRedirect } from "../../utils/redirects/handleRedirects.js"; // Import handleTwoSegmentRedirect

const { collection, slug } = Astro.params;

// 1) Define getStaticPaths using generateItemPaths which respects itemsHasPage
export async function getStaticPaths() {
  return await generateItemPaths();
}

// 2) Handle redirects using the centralized redirect handler
const redirectTo = handleTwoSegmentRedirect(collection, slug);
if (redirectTo) {
  return Astro.redirect(redirectTo);
}

let pageData;
try {
  // Fetch the page data using utility functions
  pageData = await getCollectionItemPageData(collection, slug);
} catch (error) {
  // Redirect to 404 if item not found
  return Astro.redirect("/404");
}

const { title, description, icon, featuredImage, pageTitle } = pageData;
---

<CollectionItemLayout
  title={pageTitle}
  description={description}
  image={featuredImage}
>
  <!-- Main Content Section -->
  <Section class="main-content">
    <article>
      <header>
        <h1>{icon || "ðŸ“„"} {title}</h1>
        <p>{description}</p>
        {
          featuredImage && (
            <Image
              src={featuredImage}
              alt={`${title} Featured Image`}
              class="item-image"
            />
          )
        }
      </header>
      <p>Additional item-specific content goes here...</p>
    </article>
  </Section>

  <!-- Related Sections (Services, Projects, Testimonials) -->
  <Section class="related-services">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="ParentServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="related-services">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="ChildrenServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="related-services">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="SiblingServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="related-services">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="RelatedServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="related-projects">
    <ContentTemplate collection="projects">
      <ItemsTemplate
        collection="projects"
        ItemComponent={CollectionCard}
        queryName="RelatedProjects"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="related-testimonials">
    <ContentTemplate collection="testimonials">
      <ItemsTemplate
        collection="testimonials"
        ItemComponent={CollectionCard}
        queryName="RelatedTestimonials"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>
</CollectionItemLayout>

<style>
  .item-image {
    max-width: 100%;
    height: auto;
    margin-top: 1rem;
    border-radius: 4px;
  }
  .main-content {
    /* custom styles */
  }
  .related-services,
  .related-projects,
  .related-testimonials {
    margin-top: 3rem;
  }
</style>
