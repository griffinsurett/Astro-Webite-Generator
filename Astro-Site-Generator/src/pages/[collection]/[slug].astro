---
import CollectionItemLayout from "../../layouts/CollectionItemLayout.astro";
import Section from "../../components/Section.astro";
import Image from "../../components/Image.astro";
import ContentTemplate from "../../components/ContentTemplate.astro";
import ItemsTemplate from "../../components/ItemsTemplate.astro";

import {
  getCollectionItemPageData,
  generateItemPaths,
  getAvailableCollections,
  fetchCollectionItems,
} from "../../utils/collections/";

// Components for rendering references
import ServiceCard from "../../components/ServiceCard.astro";
import CollectionCard from "../../components/CollectionsCard.astro";
import { collections } from "~/content/config";

/**
 * /[collection]/[slug].astro
 *
 * Handles two-segment routes like "/services/web-dev".
 * - Redirects to "/services/web-development" if "web-dev" is in `redirectFrom`.
 * - Detects if the collection segment is an alias (e.g., "service") and redirects to the actual collection (e.g., "services").
 * - Displays the item page if the slug matches an actual item.
 * - Redirects to 404 if neither condition is met.
 */

// 1) Generate all necessary static paths, including `redirectFrom` slugs
export async function getStaticPaths() {
  // Base paths: actual item slugs
  const basePaths = await generateItemPaths();
  // e.g., { collection: "services", slug: "seo-optimization" }

  const extraPaths = [];

  // Add `redirectFrom` slugs for items
  for (const colName of getAvailableCollections()) {
    const items = await fetchCollectionItems(colName);
    for (const itm of items) {
      if (itm.redirectFrom && itm.redirectFrom.length) {
        for (const rSlug of itm.redirectFrom) {
          extraPaths.push({ params: { collection: colName, slug: rSlug } });
        }
      }
    }

    // Add `redirectFrom` slugs for collections (e.g., "service" â†’ "services")
    if (collections[colName].metadata.redirectFrom) {
      for (const rFrom of collections[colName].metadata.redirectFrom) {
        // When the collection is an alias, we need to generate paths for all possible slugs under the actual collection
        const actualCollection = colName;
        const slugs = collections[actualCollection].data.map(item => item.slug);
        for (const slug of slugs) {
          extraPaths.push({ params: { collection: rFrom, slug } });
        }
      }
    }
  }

  // Combine and deduplicate paths
  const allPaths = [...basePaths, ...extraPaths];
  const uniquePaths = Array.from(
    new Set(allPaths.map(p => `${p.params.collection}/${p.params.slug}`))
  ).map(path => {
    const [collection, slug] = path.split("/");
    return { params: { collection, slug } };
  });

  return uniquePaths;
}

// 2) Handle the incoming request
const { collection, slug } = Astro.params;

// Function to find if the collection segment is a redirect alias
function findCollectionRedirectAlias(collectionSlug) {
  for (const colName of getAvailableCollections()) {
    const colObj = collections[colName];
    if (colObj.metadata.redirectFrom && colObj.metadata.redirectFrom.includes(collectionSlug)) {
      return colName; // Return the actual collection name
    }
  }
  return null;
}

// Check if the collection segment is an alias
const actualCollection = findCollectionRedirectAlias(collection);

if (actualCollection) {
  // If it's an alias, redirect to the actual collection with the same slug
  return Astro.redirect(`/${actualCollection}/${slug}`);
}

let pageData;
try {
  // Attempt to fetch the actual item data
  pageData = await getCollectionItemPageData(collection, slug);
} catch (error) {
  // If not found, check if the slug is a `redirectFrom` within the current collection
  const items = await fetchCollectionItems(collection);
  const redirectItem = items.find(item => item.redirectFrom && item.redirectFrom.includes(slug));

  if (redirectItem) {
    // Redirect to the actual item's slug
    return Astro.redirect(`/${collection}/${redirectItem.slug}`);
  } else {
    // Redirect to the 404 page
    return Astro.redirect("/404");
  }
}

// 3) Render the item page if found
const { title, description, icon, featuredImage, pageTitle } = pageData;
---

<CollectionItemLayout
  title={pageTitle}
  description={description}
  image={featuredImage}
>
  <!-- Main Content Section -->
  <Section class="main-content">
    <article>
      <header>
        <h1>{icon || "ðŸ“„"} {title}</h1>
        <p>{description}</p>
        {
          featuredImage && (
            <Image
              src={featuredImage}
              alt={`${title} Featured Image`}
              class="item-image"
            />
          )
        }
      </header>
      <p>Additional item-specific content goes here...</p>
    </article>
  </Section>

  <!-- Related Services -->
  <Section class="related-services">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="RelatedServices"
        slug={slug}
        currentCollection={collection}
        columns={3}
      />
    </ContentTemplate>
  </Section>

  <!-- Related Projects -->
  <Section class="related-projects">
    <ContentTemplate collection="projects">
      <ItemsTemplate
        collection="projects"
        ItemComponent={CollectionCard}
        queryName="RelatedProjects"
        slug={slug}
        currentCollection={collection}
        columns={3}
      />
    </ContentTemplate>
  </Section>

  <!-- Related Testimonials -->
  <Section class="related-testimonials">
    <ContentTemplate collection="testimonials">
      <ItemsTemplate
        collection="testimonials"
        ItemComponent={CollectionCard}
        queryName="RelatedTestimonials"
        slug={slug}
        currentCollection={collection}
        columns={3}
      />
    </ContentTemplate>
  </Section>
</CollectionItemLayout>

<style>
  .item-image {
    max-width: 100%;
    height: auto;
    margin-top: 1rem;
    border-radius: 4px;
  }
  .main-content {
    /* custom styles */
  }
  .related-services,
  .related-projects,
  .related-testimonials {
    margin-top: 3rem;
  }
</style>
