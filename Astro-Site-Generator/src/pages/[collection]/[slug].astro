---
import CollectionItemLayout from "../../layouts/CollectionItemLayout.astro";
import Section from "../../components/Section.astro";
import ContentTemplate from "../../components/ContentTemplate.astro";
import ItemsTemplate from "../../components/ItemsTemplate.astro";
import CollectionsCard from "../../components/CollectionsCard.astro";

import { generateTwoSegmentPaths, handleTwoSegmentRedirect } from "../../utils/redirects";
import { getCollectionItemPageData } from "../../utils/collections";
import { getItemSections } from "../../utils/sections.js";

const { collection, slug } = Astro.params;

/** Build static paths for each item that hasPage = true, plus any redirects. */
export async function getStaticPaths() {
  return await generateTwoSegmentPaths();
}

// 1) Check if route is a redirect
const redirectTo = handleTwoSegmentRedirect(collection, slug);
if (redirectTo) {
  return Astro.redirect(redirectTo);
}

// 2) Fetch data about this specific item
let pageData;
try {
  pageData = await getCollectionItemPageData(collection, slug);
} catch (err) {
  console.error(err);
  return Astro.redirect("/404");
}

// 3) Extract fields (title, description, featuredImage, etc.)
const { title, description, icon, featuredImage, pageTitle } = pageData;

// 4) Retrieve any ‚Äúsections‚Äù stored at the item level (item.sections).
const itemSections = getItemSections(collection, slug);
---
<CollectionItemLayout
  title={pageTitle}
  description={description}
  image={featuredImage}
>
  <!-- Main ‚Äúhero‚Äù or overview for this specific item -->
  <Section>
    <h1>{icon || "üìÑ"} {title}</h1>
    <p>{description}</p>
  </Section>

  <!-- Loop through the item-level sections for /[collection]/[slug] -->
  {itemSections.map((sec) => (
    <Section>
      <ContentTemplate collection={sec.collection}>
        <ItemsTemplate
          collection={sec.collection}
          queryName={sec.queryName}
          ItemComponent={CollectionsCard}
          slug={slug}
          currentCollection={collection}
          columns={3}
          gap="1.5rem"
        />
      </ContentTemplate>
    </Section>
  ))}
</CollectionItemLayout>