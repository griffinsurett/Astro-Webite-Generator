---
import CollectionItemLayout from "../../layouts/CollectionItemLayout.astro";
import Section from "../../components/Section.astro";
import Image from "../../components/Image.astro";
import ContentTemplate from "../../components/ContentTemplate.astro";
import ItemsTemplate from "../../components/ItemsTemplate.astro";
import ServiceCard from "../../components/ServiceCard.astro";
import CollectionCard from "../../components/CollectionsCard.astro";

import { handleTwoSegmentRedirect } from "../../utils/redirects";
import { generateTwoSegmentPaths } from "../../utils/redirects/generatePaths";
import { getCollectionItemPageData } from "../../utils/collections/";

const { collection, slug } = Astro.params;

// 1. Generate Static Paths
export async function getStaticPaths() {
  return await generateTwoSegmentPaths();
}

// 2. Handle Redirects
const redirectTo = handleTwoSegmentRedirect(collection, slug);
if (redirectTo) {
  console.log(`Redirecting /${collection}/${slug} to ${redirectTo}`);
  return Astro.redirect(redirectTo);
}

// 3. Fetch Page Data
let pageData;
try {
  pageData = await getCollectionItemPageData(collection, slug);
} catch (error) {
  console.error(`Error fetching page data for /${collection}/${slug}:`, error);
  return Astro.redirect("/404");
}

const { title, description, icon, featuredImage, pageTitle } = pageData;
---
<CollectionItemLayout
  title={pageTitle}
  description={description}
  image={featuredImage}
>
  <Section>
    <article>
      <header>
        <h1 class="text-xl font-bold mb-2">
          {icon || "ðŸ“„"} {title}
        </h1>
        <p class="text-gray-666">{description}</p>
        {featuredImage && (
          <Image
            src={featuredImage}
            alt={`${title} Featured Image`}
            className="mt-4 rounded"
          />
        )}
      </header>
      <p class="mt-4">Additional item-specific content goes here...</p>
    </article>
  </Section>

  <Section class="mt-12">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="ParentServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="mt-12">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="ChildrenServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="mt-12">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="SiblingServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <Section class="mt-12">
    <ContentTemplate collection="services">
      <ItemsTemplate
        collection="services"
        ItemComponent={ServiceCard}
        queryName="RelatedServices"
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <!-- Related Projects -->
  <Section class="mt-12">
    <ContentTemplate collection="projects">
      <ItemsTemplate
        collection="projects"
        ItemComponent={CollectionCard}
        queryName={`RelatedProjects`}
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>

  <!-- Related Testimonials -->
  <Section class="mt-12">
    <ContentTemplate collection="testimonials">
      <ItemsTemplate
        collection="testimonials"
        ItemComponent={CollectionCard}
        queryName={`RelatedTestimonials`}
        slug={slug}
        currentCollection={collection}
        columns={2}
      />
    </ContentTemplate>
  </Section>
</CollectionItemLayout>
